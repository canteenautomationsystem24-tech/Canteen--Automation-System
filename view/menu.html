<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Campus Canteen Menu | PIEMR</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg-primary: #fff7ed;
      --bg-card: #ffffff;
      --bg-secondary: #f5f5f5;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --border-color: rgba(0, 0, 0, 0.06);
      --accent: #f97316;
      --accent-hover: #ea580c;
      --accent-light: #fed7aa;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 12px 24px rgba(249, 115, 22, 0.12), 0 4px 8px rgba(0, 0, 0, 0.08);
    }
    [data-theme="dark"] {
      --bg-primary: #0f172a;
      --bg-card: #1e293b;
      --bg-secondary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --border-color: rgba(255, 255, 255, 0.1);
      --accent: #fb923c;
      --accent-hover: #f97316;
      --accent-light: #7c2d12;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3), 0 1px 2px rgba(0, 0, 0, 0.2);
      --shadow-md: 0 12px 24px rgba(249, 115, 22, 0.15), 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    * {
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .gradient-text {
      background: linear-gradient(135deg, #f97316 0%, #dc2626 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* NAV */
    nav {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-color);
    }

    nav button {
      color: var(--text-primary);
      transition: color 0.3s ease;
    }

    nav button:hover {
      color: var(--accent);
    }

    #menuSearch {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border-color: var(--border-color) !important;
    }

    #menuSearch::placeholder {
      color: var(--text-secondary);
    }

    #menuSearch:focus {
      background: var(--bg-secondary);
      border-color: var(--accent) !important;
    }

    /* MENU CARD */
    .menu-card {
      transition: all 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 18px;
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }

    .menu-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: var(--shadow-md);
      border-color: var(--accent-hover);
    }

    .menu-card img {
      transition: transform 0.3s ease;
    }

    .menu-card:hover img {
      transform: scale(1.05);
    }

    /* CATEGORY TABS */
    .category-tab {
      transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      position: relative;
      font-weight: 600;
      border-radius: 17px;
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      background: var(--bg-secondary);
      color: var(--accent);
      border: none;
      outline: none;
      cursor: pointer;
    }

    .category-tab:hover {
      background: var(--bg-secondary);
      transform: scale(1.05);
    }

    .category-tab.active {
      background: linear-gradient(90deg, var(--accent) 0%, #dc2626 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
      transform: scale(1.08);
    }

    /* BUTTONS */
    button, .btn {
      transition: transform .13s cubic-bezier(.36,1.4,.24,1), box-shadow .15s;
      will-change: transform, box-shadow;
      outline: none;
    }

    button:hover, .btn:hover {
      transform: translateY(-2px) scale(1.04);
      box-shadow: 0 5px 18px -6px rgba(249, 115, 22, 0.3);
    }

    button:active, .btn:active {
      transform: scale(0.98);
    }

    /* SCROLLBAR */
    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--accent) 0%, #dc2626 100%);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, var(--accent-hover) 0%, #b91c1c 100%);
    }

    /* CART BADGE */
    @keyframes pulse-orange {
      0%, 100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.7); }
      50% { box-shadow: 0 0 0 10px rgba(249, 115, 22, 0.1); }
    }
    .cart-badge { animation: pulse-orange 2s infinite; }

    /* MODALS */
    .fade-in { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .modal-content {
      background: var(--bg-card);
      color: var(--text-primary);
    }

    /* SETTINGS PANEL */
    .settings-panel {
      position: fixed;
      right: 0;
      top: 0;
      height: 100vh;
      width: 420px;
      background: var(--bg-card);
      box-shadow: -20px 0 60px rgba(0, 0, 0, 0.3);
      transform: translateX(100%);
      transition: transform 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      z-index: 100000;
      overflow-y: auto;
      border-left: 1px solid var(--border-color);
    }

    .settings-panel.active {
      transform: translateX(0);
      animation: slideInRight 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    @keyframes slideInRight {
      0% { transform: translateX(100%); opacity: 0.8; }
      100% { transform: translateX(0); opacity: 1; }
    }

    .setting-option {
      padding: 1.25rem 1.5rem;
      margin: 0.5rem 1rem;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      display: flex;
      align-items: center;
      gap: 1rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      position: relative;
      overflow: hidden;
    }

    .setting-option::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(249, 115, 22, 0.1), transparent);
      transition: left 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .setting-option:hover::before {
      left: 100%;
    }

    .setting-option:hover {
      background: var(--bg-secondary);
      transform: scale(1.02);
      box-shadow: 0 8px 20px rgba(249, 115, 22, 0.15);
      border-color: var(--accent);
    }

    .setting-option .icon {
      width: 52px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 14px;
      font-size: 1.6rem;
      flex-shrink: 0;
      background: linear-gradient(135deg, #667eea, #764ba2);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      color: white;
    }

    .setting-option:hover .icon {
      transform: scale(1.1) rotate(5deg);
    }

    /* TOGGLE SWITCH */
    .toggle-switch {
      width: 50px;
      height: 24px;
      background: var(--bg-secondary);
      border-radius: 12px;
      position: relative;
      cursor: pointer;
      transition: 0.3s;
      border: 1px solid var(--border-color);
    }

    .toggle-switch.active {
      background: var(--accent);
      border-color: var(--accent);
    }

    .toggle-switch::before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: var(--text-primary);
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: 0.3s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .toggle-switch.active::before {
      left: 28px;
      background: white;
    }

    /* SIDEBARS */
    #cartSidebar, #orderHistory {
      background: var(--bg-card);
      border-left: 1px solid var(--border-color);
    }

    #cartSidebar .bg-gray-50 {
      background: var(--bg-secondary) !important;
    }

    /* TEXT COLORS */
    .text-gray-500, .text-gray-400, .text-gray-600 {
      color: var(--text-secondary) !important;
    }

    .text-gray-700, .text-gray-800 {
      color: var(--text-primary) !important;
    }

    /* EMPTY STATE */
    .empty-list {
      color: var(--text-secondary);
      padding: 2.3rem 0 2rem;
      font-weight: 600;
      opacity: 0.85;
      font-size: 1.15rem;
    }

    /* RESPONSIVE */
    @media (max-width: 950px) {
      .grid-cols-3 { grid-template-columns: 1fr 1fr !important; }
    }

    @media (max-width: 650px) {
      .grid-cols-3, .grid-cols-2 { grid-template-columns: 1fr !important; }
      .settings-panel { width: 100%; }
    }
  </style>
</head>
<body data-theme="light">

  <!-- NAV -->
  <nav class="shadow-lg sticky top-0 z-40">
    <div class="max-w-7xl mx-auto flex justify-between items-center py-4 px-6">
      <div class="text-2xl font-bold gradient-text flex items-center gap-2">
        <img src="http://localhost:3000/images/piemr-logo.jpg" class="w-10 h-10 rounded-full border-2 border-orange-500" alt="Logo"/>
        Campus Canteen
      </div>
      <div class="flex items-center space-x-4">
        <input type="text" id="menuSearch" placeholder="üîç Search menu..." class="hidden md:block px-4 py-2 border-2 rounded-lg focus:ring-2 focus:ring-orange-500 w-64">
        <button onclick="toggleSettings()" class="font-medium transition">‚öôÔ∏è Settings</button>
        <button onclick="toggleOrderHistory()" class="font-medium transition">üì¶ Orders</button>
        <button onclick="toggleCart()" class="relative bg-gradient-to-r from-orange-500 to-red-600 text-white px-4 py-2 rounded-lg font-semibold btn-action">
          üõí Cart
          <span id="cartCount" class="cart-badge ml-1 bg-white text-orange-600 rounded-full px-2 text-xs font-bold">0</span>
        </button>
      </div>
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <div class="max-w-7xl mx-auto py-8 px-4">
    <div class="flex flex-wrap gap-3 mb-8 justify-center" id="categoryTabs"></div>
    <div id="menuGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
  </div>

  <!-- CART SIDEBAR -->
  <div id="cartSidebar" class="fixed right-0 top-0 h-full w-80 shadow-2xl transform translate-x-full transition-transform duration-300 z-50">
    <div class="h-full flex flex-col">
      <div class="bg-gradient-to-r from-orange-500 to-red-600 text-white p-6 flex justify-between items-center">
        <h2 class="text-2xl font-bold">üõí Cart</h2>
        <button onclick="toggleCart()" class="text-white font-bold text-2xl hover:scale-110 transition">‚úñ</button>
      </div>
      <div id="cartItems" class="flex-1 overflow-y-auto p-6"></div>
      <div class="border-t p-6 border-opacity-10">
        <div class="flex justify-between font-bold mb-2"><span>Subtotal:</span><span id="cartSubtotal">‚Çπ0</span></div>
        <div class="flex justify-between text-sm text-gray-600 mb-2"><span>Tax (5%):</span><span id="cartTax">‚Çπ0</span></div>
        <div class="flex justify-between text-xl font-bold mt-2 text-orange-600"><span>Total:</span><span id="cartTotal">‚Çπ0</span></div>
        <button onclick="proceedToCheckout()" class="btn-action w-full bg-gradient-to-r from-orange-500 to-red-600 text-white py-3 rounded-xl font-bold mt-4">üí≥ Checkout</button>
      </div>
    </div>
  </div>

  <!-- SETTINGS PANEL -->
  <div id="settingsPanel" class="settings-panel">
    <div class="bg-gradient-to-br from-purple-600 via-indigo-600 to-blue-600 text-white p-8 relative overflow-hidden">
      <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent opacity-50"></div>
      <div class="relative z-10">
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-3xl font-black tracking-tight">‚öôÔ∏è Settings</h2>
          <button onclick="toggleSettings()" class="text-white font-bold text-3xl hover:rotate-90 hover:scale-110 transition-all duration-300 active:scale-95">‚úñ</button>
        </div>
        <p class="text-purple-100 text-sm font-medium">Customize your experience</p>
      </div>
    </div>

    <div class="p-4 space-y-3">
      
      <div class="setting-option" onclick="toggleTheme()">
        <div class="icon">üåô</div>
        <div class="flex-1">
          <div class="font-bold text-lg">Dark Mode</div>
          <div class="text-sm text-gray-500">Switch theme</div>
        </div>
        <div class="toggle-switch" id="darkToggle"></div>
      </div>

      <div class="setting-option" onclick="toggleLanguage()">
        <div class="icon">üåç</div>
        <div class="flex-1">
          <div class="font-bold text-lg">Language</div>
          <div class="text-sm text-gray-500" id="langStatus">English</div>
        </div>
        <div class="toggle-switch" id="langToggle"></div>
      </div>

      <div class="setting-option" onclick="toggleNotifications()">
        <div class="icon">üîî</div>
        <div class="flex-1">
          <div class="font-bold text-lg">Notifications</div>
          <div class="text-sm text-gray-500">Order updates</div>
        </div>
        <div class="toggle-switch active" id="notifToggle"></div>
      </div>

      <div class="setting-option" onclick="toggleSettings();toggleOrderHistory(true)">
        <div class="icon">üì¶</div>
        <div class="flex-1">
          <div class="font-bold text-lg">My Orders</div>
          <div class="text-sm text-gray-500">Track orders</div>
        </div>
        <div class="text-gray-400 text-xl">‚Üí</div>
      </div>

      <div class="setting-option" onclick="clearCart()">
        <div class="icon">üóëÔ∏è</div>
        <div class="flex-1">
          <div class="font-bold text-lg text-red-600">Clear Cart</div>
          <div class="text-sm text-gray-500">Remove all</div>
        </div>
        <div class="text-red-400 text-xl">‚Üí</div>
      </div>
    </div>

    <div class="p-6 border-t">
      <button onclick="logoutFn()" class="w-full bg-gradient-to-r from-red-500 to-red-600 text-white py-4 rounded-2xl font-bold text-lg shadow-xl hover:shadow-2xl hover:scale-105 active:scale-95 transition-all duration-300 flex items-center justify-center gap-2 relative overflow-hidden">
        <span class="text-2xl">üö™</span>
        <span>Logout</span>
      </button>
    </div>
  </div>

  <!-- PAYMENT MODAL -->
  <div id="paymentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="modal-content rounded-2xl shadow-2xl p-8 max-w-md w-full fade-in text-center">
      <h2 class="text-3xl font-bold mb-6">üí≥ Payment</h2>
      <div id="orderSummary" class="bg-gray-50 rounded-xl p-4 mb-6 text-left"></div>
      <div class="space-y-4">
        <button onclick="processPayment('online')" class="btn-action w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white p-4 rounded-xl font-semibold text-lg">üí∞ Pay Online</button>
        <button onclick="processPayment('cash')" class="btn-action w-full bg-gradient-to-r from-orange-500 to-red-600 text-white p-4 rounded-xl font-semibold text-lg">üíµ Pay at Counter</button>
        <button onclick="closePaymentModal()" class="w-full text-gray-600 hover:text-gray-800 font-medium p-2">‚ùå Cancel</button>
      </div>
    </div>
  </div>

  <!-- CONFIRMATION MODAL -->
  <div id="confirmationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="modal-content rounded-2xl shadow-2xl p-8 max-w-md w-full text-center fade-in">
      <div class="bg-green-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl">‚úÖ</div>
      <h2 class="text-3xl font-bold mb-4">Order Placed!</h2>
      <div id="confirmationDetails" class="mb-6 text-gray-600"></div>
      <button onclick="closeConfirmationModal()" class="btn-action bg-gradient-to-r from-orange-500 to-red-600 text-white px-8 py-3 rounded-xl font-semibold">üì¶ Track Order</button>
    </div>
  </div>

  <!-- ORDER HISTORY -->
  <div id="orderHistory" class="fixed right-0 top-0 h-full w-80 shadow-2xl transform translate-x-full transition-transform duration-300 z-50">
    <div class="h-full flex flex-col">
      <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-6 flex justify-between items-center">
        <h2 class="text-2xl font-bold">üì¶ Orders</h2>
        <button onclick="toggleOrderHistory()" class="text-white font-bold text-2xl">‚úñ</button>
      </div>
      <div id="orderHistoryList" class="flex-1 overflow-y-auto p-6"></div>
    </div>
  </div>

  <!-- RATING MODAL -->
  <div id="ratingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="modal-content rounded-2xl shadow-2xl p-8 max-w-md w-full fade-in">
      <h2 class="text-3xl font-bold mb-6 text-center">‚≠ê Rate Your Order</h2>
      <div id="ratingOrderInfo" class="bg-gray-50 rounded-xl p-4 mb-6 text-sm"></div>
      <div class="mb-6 text-center">
        <div class="text-sm text-gray-600 mb-3">How was your experience?</div>
        <div class="flex justify-center gap-3" id="starRating">
          <span class="star text-5xl cursor-pointer transition hover:scale-125" onclick="setRating(1)">‚≠ê</span>
          <span class="star text-5xl cursor-pointer transition hover:scale-125" onclick="setRating(2)">‚≠ê</span>
          <span class="star text-5xl cursor-pointer transition hover:scale-125" onclick="setRating(3)">‚≠ê</span>
          <span class="star text-5xl cursor-pointer transition hover:scale-125" onclick="setRating(4)">‚≠ê</span>
          <span class="star text-5xl cursor-pointer transition hover:scale-125" onclick="setRating(5)">‚≠ê</span>
        </div>
      </div>
      <textarea id="ratingComment" placeholder="Any comments? (optional)" class="w-full border-2 rounded-xl p-3 mb-4 focus:ring-2 focus:ring-orange-500 focus:border-transparent" rows="3"></textarea>
      <div class="flex gap-3">
        <button onclick="closeRatingModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-300 transition">Cancel</button>
        <button onclick="submitRating()" class="flex-1 bg-gradient-to-r from-orange-500 to-red-600 text-white py-3 rounded-xl font-semibold hover:shadow-lg transition">Submit ‚≠ê</button>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="bg-[#ffaa23] text-white text-center py-7 mt-20 rounded-t-3xl shadow-xl">
    <div class="flex justify-center items-center gap-3">
      <img src="http://localhost:3000/images/piemr-logo.jpg" class="w-8 h-8 rounded-full border-2 border-white shadow bg-white" alt="Logo"/>
      <span>¬© 2025 Campus Canteen -  PIEMR, Indore</span>
    </div>
  </footer>

  <script>
    const allowedRole = "student";
    if (!localStorage.getItem("isLoggedIn") || localStorage.getItem("userRole") !== allowedRole) window.location.href = "index.html";
    function logoutFn() { localStorage.clear(); window.location.href = "index.html"; }

    let cart = [];
    let currentCategory = "all";
    let currentLang = localStorage.getItem('language') || 'en';
    let settings = { notifications: true };

    function toggleTheme() {
      const body = document.body;
      const darkToggle = document.getElementById('darkToggle');
      const currentTheme = body.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      body.setAttribute('data-theme', newTheme);
      darkToggle?.classList.toggle('active');
      localStorage.setItem('studentTheme', newTheme);
    }

    window.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('studentTheme') || 'light';
      document.body.setAttribute('data-theme', savedTheme);
      if(savedTheme === 'dark') document.getElementById('darkToggle')?.classList.add('active');
    });

    function toggleSettings() {
      document.getElementById('settingsPanel').classList.toggle('active');
    }

    function toggleLanguage() {
      currentLang = currentLang === 'en' ? 'hi' : 'en';
      localStorage.setItem('language', currentLang);
      document.getElementById('langToggle').classList.toggle('active');
      document.getElementById('langStatus').textContent = currentLang === 'en' ? 'English' : '‡§π‡§ø‡§Ç‡§¶‡•Ä';
      renderCategoryTabs();
    }

    function toggleNotifications() {
      settings.notifications = !settings.notifications;
      document.getElementById('notifToggle').classList.toggle('active');
    }

    async function getMenuItems() {
      console.log("Fetching menu items..."); // üëà DEBUG
      try {
        const res = await fetch("http://localhost:3000/api/menu");
        if (!res.ok) throw new Error("Menu fetch failed");

        const data = await res.json();

        MENU_CACHE = data.map(item => ({
          ...item,
          price: Number(item.price),
          rating: Number(item.rating),
          img: item.image_url
        }));

        console.log("MENU_CACHE:", MENU_CACHE); // üëà DEBUG

        return MENU_CACHE;
      } catch (err) {
        console.error(err);
        alert("Failed to load menu");
        return [];
      }
    
    }

    const translations = {
      en: {all:"All Items",breakfast:"üç≥ Breakfast",lunch:"üçõ Lunch",snacks:"üçï Snacks",beverages:"‚òï Beverages",desserts:"üç∞ Desserts"},
      hi: {all:"‡§∏‡§≠‡•Ä",breakfast:"üç≥ ‡§®‡§æ‡§∂‡•ç‡§§‡§æ",lunch:"üçõ ‡§¶‡•ã‡§™‡§π‡§∞ ‡§ï‡§æ ‡§ñ‡§æ‡§®‡§æ",snacks:"üçï ‡§∏‡•ç‡§®‡•à‡§ï‡•ç‡§∏",beverages:"‚òï ‡§™‡•á‡§Ø",desserts:"üç∞ ‡§Æ‡§ø‡§†‡§æ‡§à"}
    };

    function renderCategoryTabs() {
      let cats = ["all","breakfast","lunch","snacks","beverages","desserts"];
      let labels = cats.map(c => translations[currentLang][c]);
      document.getElementById("categoryTabs").innerHTML = cats.map((cat,i) =>
        `<button onclick="filterCategory('${cat}')" class="category-tab${cat===currentCategory?' active':''}">${labels[i]}</button>`
      ).join("");
    }

    async function renderMenu(category="all", search="") {
      const grid = document.getElementById("menuGrid");
      let menuItems = await getMenuItems();
      let filtered = menuItems;
      if(category!=="all") filtered = filtered.filter(item => item.category===category);
      if(search) filtered = filtered.filter(item =>
        item.name.toLowerCase().includes(search.toLowerCase()) ||
        (item.description && item.description.toLowerCase().includes(search.toLowerCase()))
      );
      grid.innerHTML = filtered.length===0 ?
        `<div class="empty-list col-span-3 text-center">üòï No items found!</div>`
      : filtered.map(item => `
        <div class="menu-card">
          <img src="${item.img||'https://via.placeholder.com/300x200?text=No+Image'}" alt="${item.name}" style="width:100%;height:180px;object-fit:cover;border-radius:12px 12px 0 0;" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image';">
          <div style="padding:1rem">
            <h3 class="font-bold text-xl mb-1">${item.name}</h3>
            <p class="text-gray-600 text-sm mb-2">${item.description||""}</p>
            <div class="flex justify-between items-center mb-3">
              <span class="text-orange-500 font-black text-xl">‚Çπ${item.price}</span>
              <span class="text-yellow-400 text-sm">‚≠ê${item.rating||'4.5'}</span>
            </div>
            <button onclick="addToCart(${item.id})" class="btn-action w-full px-4 py-2 bg-gradient-to-r from-orange-400 to-red-400 text-white rounded-lg font-bold shadow">${item.available!==false ? "Add to Cart" : "Out of Stock"}</button>
          </div>
        </div>
      `).join('');
    }

    document.getElementById('menuSearch')?.addEventListener('input', (e) => {
      renderMenu(currentCategory, e.target.value);
    });

    function addToCart(itemId) {
      const item = MENU_CACHE.find(i => i.id === itemId);
      if (!item) return;

      const existing = cart.find(i => i.id === itemId);
      if (existing) {
        existing.quantity += 1;
      } else {
        cart.push({ ...item, quantity: 1 });
      }

      updateCart();
      renderCart();
    }

    function updateCart() {
      document.getElementById("cartCount").textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
    }

    function renderCart() {
      const cartDiv = document.getElementById("cartItems");
      if(cart.length === 0) {
        cartDiv.innerHTML = "<div class='text-center text-gray-400 mt-20'>Cart is empty</div>";
        document.getElementById("cartSubtotal").textContent = "‚Çπ0";
        document.getElementById("cartTax").textContent = "‚Çπ0";
        document.getElementById("cartTotal").textContent = "‚Çπ0";
        return;
      }
      let subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
      let tax = Math.round(subtotal * 0.05);
      let total = subtotal + tax;
      cartDiv.innerHTML = cart.map(item => `
        <div class='flex mb-4 items-center'>
          <img src="${item.img}" style="width:50px;height:50px;object-fit:cover;border-radius:8px;margin-right:12px;" onerror="this.src='https://via.placeholder.com/50';">
          <div class="flex-1">
            <div class="font-bold">${item.name} (${item.quantity})</div>
            <div class="text-sm text-gray-500">‚Çπ${item.price * item.quantity}</div>
          </div>
          <button onclick="removeFromCart(${item.id})" class="ml-3 text-red-600 hover:scale-125 transition">‚úñ</button>
        </div>
      `).join('');
      document.getElementById("cartSubtotal").textContent = "‚Çπ" + subtotal;
      document.getElementById("cartTax").textContent = "‚Çπ" + tax;
      document.getElementById("cartTotal").textContent = "‚Çπ" + total;
    }

    function removeFromCart(itemId) {
      cart = cart.filter(i => i.id !== itemId);
      updateCart();
      renderCart();
    }

    function filterCategory(category) {
      currentCategory = category;
      renderMenu(category);
      renderCategoryTabs();
    }

    function clearCart() {
      if(cart.length === 0) { alert('Cart is already empty!'); return; }
      if(confirm('Clear all items?')) {
        cart = [];
        updateCart();
        renderCart();
        alert('Cart cleared! ‚úÖ');
      }
    }

    function proceedToCheckout() {
      if(cart.length === 0) return;
      document.getElementById("paymentModal").classList.remove("hidden");
      document.getElementById("orderSummary").innerHTML = cart.map(item => `<div>${item.name} x${item.quantity}: ‚Çπ${item.price * item.quantity}</div>`).join('') +
        `<div class="mt-2"><strong>Total: ${document.getElementById("cartTotal").textContent}</strong></div>`;
    }

    async function processPayment(method) {
      try {
        document.getElementById("paymentModal").classList.add("hidden");

        const token = localStorage.getItem("jwtToken");
        if (!token) {
          alert("Login required");
          return;
        }

        if (cart.length === 0) {
          alert("Cart is empty");
          return;
        }

        // calculate amounts
        const subtotal = cart.reduce((s, i) => s + i.price * i.quantity, 0);
        const tax = Math.round(subtotal * 0.05);
        const total = subtotal + tax;

        console.log("Processing payment...", { method, cart, subtotal, tax, total }); // üëà DEBUG

        const payload = {
          token,
          items: cart.map(i => ({
            id: i.id,
            name: i.name,
            price: i.price,
            quantity: i.quantity
          })),
          subtotal,
          tax,
          total
        };

        const res = await fetch("http://localhost:3000/api/user/order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || "Order failed");
        }

        const order = await res.json(); // DB order

        // ‚úÖ show confirmation
        document.getElementById("confirmationModal").classList.remove("hidden");
        document.getElementById("confirmationDetails").innerHTML = `
          Order <b>${order.order_id}</b> placed!<br>
          Payment: ${method === "online" ? "Online" : "Cash"}<br>
          Status: ${order.status}
        `;

        // clear cart
        cart = [];
        updateCart();
        renderCart();

        // reload order history from DB
        await renderOrderHistory();

      } catch (err) {
        console.error("Payment error:", err);
        alert(err.message || "Payment failed");
      }
    }

    function closePaymentModal() {
      document.getElementById("paymentModal").classList.add("hidden");
    }

    function closeConfirmationModal() {
      document.getElementById("confirmationModal").classList.add("hidden");
      toggleOrderHistory(true);
    }

    let currentRatingOrderId = null;
    let selectedRating = 0;

    async function renderOrderHistory() {
      const list = document.getElementById("orderHistoryList");
      if (!list) return;

      list.innerHTML = "<div class='text-center mt-20'>Loading...</div>";

      try {
        const token = localStorage.getItem("jwtToken");
        if (!token) {
          list.innerHTML = "<div class='text-center text-red-500'>Login required</div>";
          return;
        }

        const res = await fetch("http://localhost:3000/api/user/order-history", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ token })
        });

        if (!res.ok) throw new Error("Failed to load orders");

        const orders = await res.json();

        if (orders.length === 0) {
          list.innerHTML =
            "<div class='text-center text-gray-400 mt-20'>No orders yet</div>";
          return;
        }

        list.innerHTML = orders.map(order => `
          <div class="border-b pb-4 mb-4 border-opacity-10">
            <div class="font-bold">Order: ${order.order_id}</div>
            <div class="text-sm">
              Items:
              ${
                order.order_items.map(i => `${i.name} x${i.quantity}`).join(", ")
              }
            </div>
            <div class="text-sm">Total: ‚Çπ${order.total_amount}</div>
            <div class="mt-1 text-orange-600 font-bold">Status: ${order.status}</div>
            <div class="text-xs text-gray-500">
              ${new Date(order.created_at).toLocaleString()}
            </div>
          </div>
        `).join("");

      } catch (err) {
        console.error(err);
        list.innerHTML =
          "<div class='text-center text-red-500 mt-20'>Failed to load orders</div>";
      }
    }


    function openRatingModal(orderId, orderIdx) {
      currentRatingOrderId = orderId;
      currentRatingOrderIdx = orderIdx;
      selectedRating = 0;
      document.getElementById('ratingModal').classList.remove('hidden');
      document.getElementById('ratingComment').value = '';
      let orders = JSON.parse(localStorage.getItem("orders")) || [];
      let order = orders.find(o => o.id === orderId);
      if(order) {
        document.getElementById('ratingOrderInfo').innerHTML = `
          <div class="font-bold">Order: ${order.id}</div>
          <div class="text-xs">Items: ${order.items.join(", ")}</div>
        `;
      }
      updateStarDisplay();
    }

    function setRating(stars) {
      selectedRating = stars;
      updateStarDisplay();
    }

    function updateStarDisplay() {
      const starElements = document.querySelectorAll('#starRating .star');
      starElements.forEach((star, idx) => {
        if(idx < selectedRating) {
          star.style.filter = 'grayscale(0%)';
          star.style.opacity = '1';
        } else {
          star.style.filter = 'grayscale(100%)';
          star.style.opacity = '0.3';
        }
      });
    }

    function submitRating() {
      if(selectedRating === 0) {
        alert('Please select a rating!');
        return;
      }
      let orders = JSON.parse(localStorage.getItem("orders")) || [];
      let orderIdx = orders.findIndex(o => o.id === currentRatingOrderId);
      if(orderIdx !== -1) {
        orders[orderIdx].rated = true;
        orders[orderIdx].rating = selectedRating;
        orders[orderIdx].ratingComment = document.getElementById('ratingComment').value;
        localStorage.setItem("orders", JSON.stringify(orders));

        let menuItems = getMenuItems();
        orders[orderIdx].items.forEach(itemStr => {
          let itemName = itemStr.split(' x');
          let menuItem = menuItems.find(m => m.name === itemName);
          if(menuItem) {
            let ratings = JSON.parse(localStorage.getItem("itemRatings")) || {};
            if(!ratings[itemName]) ratings[itemName] = [];
            ratings[itemName].push(selectedRating);
            localStorage.setItem("itemRatings", JSON.stringify(ratings));
          }
        });

        closeRatingModal();
        renderOrderHistory();
        alert('Thank you for your feedback! ‚≠ê');
      }
    }

    function closeRatingModal() {
      document.getElementById('ratingModal').classList.add('hidden');
      currentRatingOrderId = null;
      selectedRating = 0;
    }

    function toggleCart() {
      let sidebar = document.getElementById("cartSidebar");
      sidebar.style.transform = sidebar.style.transform === "translateX(0%)" ? "translateX(100%)" : "translateX(0%)";
    }

    function toggleOrderHistory(forceOpen=false) {
      let sidebar = document.getElementById("orderHistory");
      if(forceOpen) sidebar.style.transform = "translateX(0%)";
      else sidebar.style.transform = sidebar.style.transform === "translateX(0%)" ? "translateX(100%)" : "translateX(0%)";
      renderOrderHistory();
    }

    function liveMenuSync(){
      renderMenu(currentCategory, document.getElementById('menuSearch')?.value || "");
      renderCategoryTabs();
    }

    window.onload = function() {
      renderMenu();
      renderCategoryTabs();
      renderCart();
      renderOrderHistory();
      setInterval(liveMenuSync, 1000*60); // Sync every 60 seconds
    };
  </script>

</body>
</html>
